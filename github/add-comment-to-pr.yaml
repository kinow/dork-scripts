name: CI

permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write

on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Other steps here...

    # Example step that reads a file generated by a previous step into an env var
    - name: Read benchmark_table.md contents into environment variable
      # Disabled as the previous step will always fail.
      if: false
      id: readfile
      run: |
        COMMENT_BODY="$(cat benchmark_table.md)"
        # Use echo with special syntax to set an output
        echo "comment_body<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # This step writes the comment to the GitHub repository. It updates the existing
    # comment like Codecov/coverage. It reads the env var from the previous step with
    # the contents of the file. If you have the contents some other way, without a
    # file, just write it directly here (it's JavaScript).
    - name: Create comment using github-script
      uses: actions/github-script@v8
      if: github.event_name == 'pull_request'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const marker = "<!-- benchmark-comment -->";
          const newBody = `${marker}\n${{ steps.readfile.outputs.comment_body }}`;
          
          // Fetch existing comments
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          // Look for a comment from the bot with the marker
            const existing = comments.find(comment =>
            comment.user.type === "Bot" && comment.body.includes(marker)
          );
          
          if (existing) {
            // Update the existing comment
            await github.rest.issues.updateComment({
            comment_id: existing.id,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: newBody
          });
            console.log("Updated existing comment");
          } else {
            // Create a new comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: newBody
            });
              console.log("Created new comment");
            }
